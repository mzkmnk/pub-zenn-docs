---
title: "NgRxã®ã‚¤ãƒ™ãƒ³ãƒˆãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã«ã¤ã„ã¦"
emoji: "ğŸ˜"
type: "tech"
topics: ["Angular", "NgRx"]
published: true
---

## NgRx@v19.2

NgRx@v19.2ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ä¸‹è¨˜ã®ãƒ—ãƒ©ã‚°ã‚¤ãƒ³ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸã€‚
https://github.com/ngrx/platform/commit/980cf6f96d36cb0224f5bc6e3968d5bd8aef73f9

ã“ã‚Œã¯ NgRx SignalStore ã«ã‚¤ãƒ™ãƒ³ãƒˆãƒ™ãƒ¼ã‚¹ã®çŠ¶æ…‹ç®¡ç†æ©Ÿèƒ½ã¨ãªã‚Šã¾ã™ã€‚
Flux ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã‹ã‚‰å½±éŸ¿ã‚’å—ã‘ã¦é–‹ç™ºã—ãŸã‚ˆã†ã§ã€`NgRx Store`,`NgRx Effects`,`RxJS`ã®ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å–ã‚Šå…¥ã‚Œã¦ã‚‹ã‚ˆã†ã§ã™ã€‚
ãŸã ã€ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã¯ã¾ã [å®Ÿé¨“çš„æ©Ÿèƒ½(experimental)](https://github.com/ngrx/platform/commit/980cf6f96d36cb0224f5bc6e3968d5bd8aef73f9#diff-eb04585c51a02fb292ca1a76de4d1f03d85442d602f5ed50ddacfb1b79ccf213R23)ã¨ã—ã¦æä¾›ã•ã‚Œã¦ã‚‹ã¿ãŸã„ã§ã™ã€‚

ä»Šå›ã¯ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ã‚’è©¦ã—ã¦ã„ããŸã„ã¨æ€ã„ã¾ã™ã€‚
ãƒ‡ãƒ¼ã‚¿ã‚„ API ã¯[dummyjson](https://dummyjson.com/docs/todos)ã‚’ä½¿ã‚ã›ã¦ã‚‚ã‚‰ã„ã¾ã™ã€‚

## ä½¿ç”¨æ–¹æ³•

### ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©

ã‚¢ã‚¯ã‚·ãƒ§ãƒ³å®šç¾©ã«ã¯`eventGroup`ã‚’ä½¿ã„ã¾ã™ã€‚

```ts
export const todosPageEvents = eventGroup({
  source: "Todo Events", // ã‚¤ãƒ™ãƒ³ãƒˆåã®å®šç¾©
  events: {
    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©
    created: type<void>(),
    updated: type<void>(),
  },
});
```

### çŠ¶æ…‹å¤‰æ›´

ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã—ãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§çŠ¶æ…‹ã‚’å¤‰åŒ–ã™ã‚‹å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã«ã¯ã€`withReducer`,`on`ã‚’ä½¿ã„ã¾ã™ã€‚
`on`é–¢æ•°ã«ã¯ã€1 ã¤ä»¥ä¸Šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ã€æœ€å¾Œã®å¼•æ•°ã«ã€é…åˆ—ã‚’è¿”ã™é–¢æ•°ã‚’å®šç¾©ã—ã¾ã™ã€‚
ã“ã®é…åˆ—ã«ã¯ã€è¤‡æ•°ã®é–¢æ•°ã‚’å®šç¾©ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚
ã¾ãŸ,ã‚¤ãƒ™ãƒ³ãƒˆã§å®šç¾©ã—ãŸå€¤ã® Type ã‚’ã€`({payload}) => []`ã¨ã„ã£ãŸå½¢ã§å—ã‘å–ã‚Œã¾ã™ã€‚
ã“ã®`payload`ã§ã™ãŒã€2 ã¤ä»¥ä¸Šã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’å®šç¾©ã—ãŸå ´åˆã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã§å®šç¾©ã—ãŸå€¤ã® Type ã®ãƒ¦ãƒ‹ã‚ªãƒ³å‹ã«ãªã‚Šã¾ã™ã€‚

```diff ts:todos.store.ts
import { signalStore, withState } from "@ngrx/signals";
import { Todo } from "../type/todo.type";
import { on, withReducer } from "@ngrx/signals/events";
import { todosPageEvents } from "./todos.action";

type Todos = {
  isLoading: boolean;
  data: Todo[];
};

export const TodosStore = signalStore(
  { providedIn: "root" },
  withState<Todos>({
    isLoading: false,
    data: [],
  }),
  // here
+  withReducer(
+    on(todosPageEvents.created, todosPageEvents.updated, () => [
+      function setIsLoading() {
+        return {
+          isLoading: true,
+        };
+      },
+    ])
+  )
);
```

è¤‡æ•°é–¢æ•°ã®å ´åˆã¯ä¸‹è¨˜ã®ã‚ˆã†ã«æ›¸ãã¨è‰¯ã•ãã†ã§ã™ã€‚

```diff ts:todos.store.ts
+ function setLoading(isLoading:boolean): Pick<Todos,'isLoading'>{
+    return {
+        isLoading
+    }
+}

+ function setTodos(todos:Todo[]): Pick<Todos,'data'>{
+    return {
+        data: todos
+    }
+}

export const TodosStore = signalStore(
  { providedIn: 'root' },
  withState<Todos>({
    isLoading: false,
    data: [],
  }),
+  withReducer(
+    on(/** ... */, () => [
+      setLoading(false),
+      setTodos(/** ... */),
+    ])
+  )
);
```

### å‰¯ä½œç”¨ã®å®šç¾©

å‰¯ä½œç”¨ã®å®šç¾©ã¯`withEffects`é–¢æ•°ã‚’ä½¿ã„ã¾ã™ã€‚
å„å‰¯ä½œç”¨ã¯`Events`ã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½¿ç”¨ã—ã€ã‚¤ãƒ™ãƒ³ãƒˆãŒç™ºç«ã•ã‚ŒãŸã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å®Ÿè¡Œã•ã‚Œã‚‹`Observable`ã‚’å®šç¾©ã—ã¾ã™ã€‚

```diff ts:todos.store.ts
export const TodosStore = signalStore(
  { providedIn: 'root' },
  withState<Todos>(/** ... */),
  withReducer(/** ... */),
  // here
+  withEffects((_store, events = inject(Events), todoAPI = inject(TodoAPI)) => ({
+    loadTodos$: events.on(todosPageEvents.loaded).pipe(
+      exhaustMap(() =>
+        todoAPI.getTodos().pipe(
+          mapResponse({
+            next: ({ todos }) => todosApiEvents.loadedSuccess(todos),
+            error: () => todosApiEvents.loadedFailure(),
+          })
+        )
+      )
+    ),
+  }))
);
```

:::message alert
tapã‚„tapResponseãªã©ã€å€¤ã‚’ãã®ã¾ã¾è¿”ã—ã¦ã—ã¾ã†ã€ã¤ã¾ã‚Šä¸‹æµã«æµã‚ŒãŸå€¤ãŒã‚¤ãƒ™ãƒ³ãƒˆã§ãªã„ã¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãŒç™ºç«ã—ã¾ã›ã‚“ã€‚
:::

### Component ã§ã®åˆ©ç”¨æ–¹æ³•

ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆå´ã§ã¯ã€ä»Šã¾ã§åŒæ§˜ã« Store ã‚’ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã«æ³¨å…¥ã™ã‚‹å½¢ã§åˆ©ç”¨ã§ãã¾ã™ã€‚

```ts:app.component.ts
import { ChangeDetectionStrategy, Component, inject } from "@angular/core";
import { TodosStore } from "./todos/todos.store";

@Component({
  selector: "app-root",
  template: `...`,
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class AppComponent {
  private readonly todosStore = inject(TodosStore);
}
```

ã¾ãŸã€ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®ç™ºè¡Œã‚’è¡Œã†æ–¹æ³•ã¯ 2 é€šã‚Šã‚ã‚Šã¾ã™ã€‚

#### `Dispatcher`ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•

ã“ã®æ–¹æ³•ã§ã¯ã€`Dispatcher`ã‚µãƒ¼ãƒ“ã‚¹ã‚’æ³¨å…¥ã—ã€ãã‚Œã‚’ç”¨ã„ã¦ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¡Œã™ã‚‹å½¢ã«ãªã‚Šã¾ã™ã€‚
åˆ©ç‚¹ã¯ã€è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ç™ºè¡Œã§ãã¾ã™ã€‚

```diff ts:app.component.ts
import { ChangeDetectionStrategy, Component, inject } from '@angular/core';
import { TodosStore } from './todos/todos.store';
import { Dispatcher } from '@ngrx/signals/events';
import { todosPageEvents } from './todos/todos.action';

@Component({
  selector: 'app-root',
  template: `...`,
  changeDetection: ChangeDetectionStrategy.OnPush
})
export class AppComponent {
  private readonly dispatcher = inject(Dispatcher);

  private readonly todosStore = inject(TodosStore);

  getTodos(): void {
+    this.dispatcher.dispatch(todosPageEvents.loaded());
  }
}
```

#### `injectDispatch`ã‚’åˆ©ç”¨ã™ã‚‹æ–¹æ³•

ã“ã®æ–¹æ³•ã§ã¯,`injectDispatch`ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ³¨å…¥ã§ãã¾ã™ã€‚
åˆ©ç‚¹ã¯ã€æ³¨å…¥ã—ãŸã‚¤ãƒ™ãƒ³ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³ä»¥å¤–åˆ©ç”¨ã§ããªã„ã®ã§ã‚³ãƒ¼ãƒ‰ã®å¯èª­æ€§ãŒä¸ŠãŒã‚Šã¾ã™ã€‚

```diff ts:app.component.ts
import { ChangeDetectionStrategy, Component, inject } from "@angular/core";
import { TodosStore } from "./todos/todos.store";
import { Dispatcher } from "@ngrx/signals/events";
import { todosPageEvents } from "./todos/todos.action";

@Component({
  selector: "app-root",
  template: `...`,
  changeDetection: ChangeDetectionStrategy.OnPush,
})
export class AppComponent {
  private readonly dispatcher = inject(Dispatcher);

  private readonly todosPageEventsDispatch = injectDispatch(todosPageEvents);

  getTodos(): void {
+    this.todosPageEventsDispatch.loaded();
  }
}
```

### `signalStoreFeature`ã¨ã®è¦ªå’Œæ€§

signalStore ã¯å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã‘ã¾ã™ãŒã€`signalStoreFeature`é–¢æ•°ã¨çµ„ã¿åˆã‚ã›ã‚‹ã¨ã‹ãªã‚Šã™ã£ãã‚Šã—ãŸã‚³ãƒ¼ãƒ‰ãŒæ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

ä¸‹è¨˜ã‚³ãƒ¼ãƒ‰ã§ã¯ã€`withReducer`ã‚„`withEffects`ã‚’åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã«æ›¸ã„ã¦ã„ã¾ã™ã€‚

```ts:with-todos-reducer.ts
import { signalStore, withState } from '@ngrx/signals';
import { Todo } from '../type/todo.type';
import {
  Dispatcher,
  Events,
  on,
  withEffects,
  withReducer,
} from '@ngrx/signals/events';
import { todosApiEvents, todosPageEvents } from './todos.action';
import { inject } from '@angular/core';
import { TodoAPI } from './todo.api';
import { exhaustMap, map } from 'rxjs';
import { mapResponse } from '@ngrx/operators';

type Todos = {
  isLoading: boolean;
  data: Todo[];
};

export const TodosStore = signalStore(
  { providedIn: 'root' },
  withState<Todos>({
    isLoading: false,
    data: [],
  }),
  withReducer(
    on(todosPageEvents.loaded, todosPageEvents.updated, () => [
      setLoading(true),
    ]),
    on(todosApiEvents.loadedSuccess, ({ payload }) => [
      setLoading(false),
      setTodos(payload),
    ])
  ),
  withEffects(
    (
      store,
      events = inject(Events),
      todoAPI = inject(TodoAPI),
      dispatcher = inject(Dispatcher)
    ) => ({
      loadTodos$: events.on(todosPageEvents.loaded).pipe(
        exhaustMap(() =>
          todoAPI.getTodos().pipe(
            mapResponse({
              next: ({ todos }) => todosApiEvents.loadedSuccess(todos),
              error: () => todosApiEvents.loadedFailure(),
            })
          )
        )
      ),
      updateTodo$: events.on(todosPageEvents.updated).pipe(
        map(({ payload }) => {
          const { id, todo } = payload;

          const todos = store.data().map((value) => {
            if (value.id === id) {
              return {
                ...value,
                ...todo,
              };
            }

            return value;
          });

          return todosApiEvents.loadedSuccess(todos);
        })
      ),
    })
  )
);

function setLoading(isLoading: boolean): Pick<Todos, 'isLoading'> {
  return {
    isLoading,
  };
}

function setTodos(todos: Todo[]): Pick<Todos, 'data'> {
  return {
    data: todos,
  };
}
```

ãŸã ã“ã‚Œã‚‰ã‚’`signalStoreFeature`é–¢æ•°ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã€`reducer`éƒ¨åˆ†ã‚„`effects`éƒ¨åˆ†ã§åˆ‡ã‚Šåˆ†ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

#### `withReducer`ã®éƒ¨åˆ†

```ts:with-todos-effects.ts
import { signalStoreFeature, type } from '@ngrx/signals';
import { on, withReducer } from '@ngrx/signals/events';
import { todosApiEvents, todosPageEvents } from './todos.action';
import { Todo, Todos } from '../type/todo.type';

export function withTodosReducer() {
  return signalStoreFeature(
    { state: type<Todos>() },
    withReducer(
      on(todosPageEvents.loaded, todosPageEvents.updated, () => [
        setLoading(true),
      ]),
      on(todosApiEvents.loadedSuccess, ({ payload }) => [
        setLoading(false),
        setTodos(payload),
      ])
    )
  );
}

function setLoading(isLoading: boolean): Pick<Todos, 'isLoading'> {
  return {
    isLoading,
  };
}

function setTodos(todos: Todo[]): Pick<Todos, 'data'> {
  return {
    data: todos,
  };
}
```

#### `withEffects`ã®éƒ¨åˆ†

```ts
import { inject } from "@angular/core";
import { signalStoreFeature, type } from "@ngrx/signals";
import { Events, withEffects } from "@ngrx/signals/events";
import { TodoAPI } from "./todo.api";
import { todosApiEvents, todosPageEvents } from "./todos.action";
import { exhaustMap, map } from "rxjs";
import { mapResponse } from "@ngrx/operators";
import { Todos } from "../type/todo.type";

export function withTodosEffects() {
  return signalStoreFeature(
    { state: type<Todos>() },
    withEffects(
      (store, events = inject(Events), todoAPI = inject(TodoAPI)) => ({
        loadTodos$: events.on(todosPageEvents.loaded).pipe(
          exhaustMap(() =>
            todoAPI.getTodos().pipe(
              mapResponse({
                next: ({ todos }) => todosApiEvents.loadedSuccess(todos),
                error: () => todosApiEvents.loadedFailure(),
              })
            )
          )
        ),
        updateTodo$: events.on(todosPageEvents.updated).pipe(
          map(({ payload }) => {
            const { id, todo } = payload;

            const todos = store.data().map((value) => {
              if (value.id === id) {
                return {
                  ...value,
                  ...todo,
                };
              }

              return value;
            });

            return todosApiEvents.loadedSuccess(todos);
          })
        ),
      })
    )
  );
}
```

ä¸Šè¨˜ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã§ store æœ¬ä½“ãŒã‹ãªã‚Šã™ã£ãã‚Šã—ã¾ã™ã€‚

```ts:todos.store.ts
import { signalStore, withState } from '@ngrx/signals';
import { Todos } from '../type/todo.type';
import { withTodosReducer } from './with-todos-reducer';
import { withTodosEffects } from './with-todos-effects';

const state: Todos = {
  isLoading: false,
  data: [],
};

export const TodosStore = signalStore(
  { providedIn: 'root' },
  withState<Todos>(state),
  withTodosReducer(),
  withTodosEffects()
);
```

### æœ€å¾Œã«

`signalStore`ã§ã¯ flux æ€è€ƒã§ã‚„ã‚‹ã«ã¯åˆ¥é€”ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å…¥ã‚Œã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã—ãŸãŒã€ä»Šå›ã®ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã§ flux æ€è€ƒã«è¿‘ã„å½¢ã§æ›¸ã‘ã‚‹ã‚ˆã†ãªã£ãŸã¨æ€ã„ã¾ã™ã€‚
ã“ã“ã§ä½œæˆã—ãŸã‚‚ã®ã¯ github ã®æ–¹ã«ã‚ã’ã¦ãŠãã¾ã™ã€‚

https://github.com/mzkmnk/ngrx-with-events-projects
